#!/usr/bin/env node

/**
 * @Authors Arjun Variar & Prakhar Srivastav.
 * @Purpose Integerates POSTMAN Collection runner/tests with CI systems.
 * 
 * Main file which parses the command line arguments and runs Newman, Supports JSON5.
 */

var color   = require('cli-color'),
	program = require('commander'),
	path    = require('path'),
	request = require('unirest'),
	fs      = require('fs'),
	Helpers = require('../src/utilities/Helpers.js'),
	JSON5   = require('json5'),
	Newman  = require('../src/Newman');

function parseArguments() {
	program
	  .version('0.0.1')
	  .usage('[options] file')
	  .option('-c, --collection [file]', 'Specify your Postman Collection [file]', null)
	  .option('-u, --url [url]', 'Specify your Postman Collection [url]', null)
	  .option('-e, --environment [file]', 'Specify your Postman Environment [file]', null)
	  .option('-t, --test', 'Run the Test Cases.', null)
	  .option('-d, --data [file]', 'Specify a data file to use', null)
	  .option('-r, --runner', 'Define Which runner to pick.', null)
	  .option('-n, --number [number]', 'Define the number of iterations to run.', null)
	  .option('-o, --outputFile [file]', 'Path to file where output should be written. [file]', null);

	program.on('--help', function() {
	  console.log('  Examples:');
	  console.log('');
	  console.log('    newman -c POSTMAN_COLLECTION');
	  console.log('    newman -u POSTMAN_COLLECTION -e POSTMAN_ENVIRONMENT');
	});

	program.parse(process.argv);

	if (!fs.existsSync(program.collection) && !(program.url)) {
		terminateWithError('Please specify a Postman Collection either as a file or a URL');
	}

	if (program.url && !Helpers.isValidUrl(program.url)) {
		terminateWithError('Please specify a valid URL');
	}
	
	if (program.data) {
		if (!fs.existsSync(program.data)) {
			terminateWithError("The data file passed is not a valid json / csv file");
		}
	}
}

function terminateWithError(msg) {
	console.warn(color.red(msg));
	process.exit(1);
}

function main() {
	parseArguments();
	
	newmanOptions = {};

	if (program.environment) {
		// in case of environment variable set the envJson property 
 		// on the options object
		newmanOptions.envJson = JSON5.parse(fs.readFileSync(program.environment, 'utf8'));
	}

	if (program.runner) {
		newmanOptions.responseHandler = program.runner;
	}

	if (program.test) {
		newmanOptions.responseHandler = 'TestResponseHandler';
	}

	if (program.number) {
		newmanOptions.iterationCount = program.number;
	}

	if (program.outputFile) {
		newmanOptions.outputFile = program.outputFile;
	}

	if (program.data) {
		newmanOptions.datafile = program.data;
	}

	if (program.collection) {
		// read collection from the filesystem
		var collectionJson = JSON5.parse(fs.readFileSync(program.collection, 'utf8'));
		Newman.execute(collectionJson, newmanOptions);

	} else {
		// get collection from url
		request.get(program.url).type('json').end(function(data) {
			if (data.error) {
				terminateWithError('Unable to fetch a valid response. Error: ' + data.code);
			}
			Newman.execute(data.body, newmanOptions);
		});
	}
}

main();
